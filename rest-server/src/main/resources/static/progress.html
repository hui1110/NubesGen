<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Azure Spring Apps Launcher Loading</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/vue3-toastify@0.1.4/dist/index.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.5/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.2.1/ansi_up.min.js"></script>
</head>
<style>
    #app {
        background-color: #005fff;
        padding-bottom: 30px;
    }
    img {
        width: 10%;
        vertical-align: middle;
        margin-top: -1%;
    }
    a{
        color: black;
    }
    .loading {
        width: 75%;
        margin: 4% auto 4%;
        background-color: white;
    }
    .icon-loading::before {
        color: white;
        font-size: 24px;
        background-color: #3366FF;
        border-radius: 50% 50%;
        animation: spin 1s infinite;
    }
    .icon-success {
        color: green;
        font-size: 24px;
    }
    .icon-error::before {
        color: red;
        font-size: 24px;
        vertical-align: 3px;
    }
    .inactive::before {
        background-color: #E0E0E0;
    }
    .rotating {
        animation: rotation 2s infinite linear;
    }
    @keyframes rotation {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
    .icon-container {
        width: 24px;
        height: 24px;
        float: right;
        padding-bottom: 5px;
    }
    .log {
        background-color: #f8f9fa;
        height: 400px;
        overflow: auto;
        padding: 15px;
        border: 1px solid #d6d8db;
    }

    .log > pre:nth-child(2) {
        overflow: unset;
    }

    .stages {
        padding-top: 10px;
    }

    .title {
        padding: 0.5%;
        background-color: white;
    }
    .launcher {
        font-weight: 750;
        display: inline-block;
        margin-left: 20px;
        margin-top: 1.5%;
    }
    .back {
        font-weight: 650;
        float: right;
        padding-right: 10px;
        margin-top: 1.5%;
    }
    .point{
        padding-left: 5%;
        padding-top: 2%;
        padding-bottom: 2%;
    }

</style>
<body>
<div id="app">
    <div class="title">
        <img src="img/nubesgen-logo.svg" alt="NubesGen logo">
        <label class="launcher">Azure Spring Apps Web Launcher</label>
        <label class="back">Back to <a href="/">NubesGen.com</a></label>
    </div>
    <div class="loading">
        <div class="card border-light">
            <div class="card-body">
                <h6>{{deploymentProgress}}</h6>
                <span style="font-size: 14px;">{{deploymentResult}}</span>
            </div>
            <div class="card">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item" v-for="item in stages" :key="item.key">
                        <div class="icon-container" v-show="item.status === 'success'">
                            <i class="bi bi-check-circle-fill icon-success"></i>
                        </div>
                        <div class="icon-container rotating" v-show="item.status === 'loading'">
                            <i class="bi bi-arrow-repeat icon-loading"></i>
                        </div>
                        <div class="icon-container" v-show="item.status === 'wait'">
                            <i class="bi bi-arrow-repeat icon-loading inactive"></i>
                        </div>
                        <div class="icon-container" v-show="item.status === 'error'">
                            <i class="bi bi-exclamation-circle-fill icon-error"></i>
                        </div>
                        <i @click="handleListItemCollapse(item.key)" class="bi bi-chevron-right"
                           :id="item.key" data-toggle="collapse" :data-target="'#'+item.id"></i>
                        <span class="ml-2">{{item.stageName}}</span>
                        <div class="collapse stages" :id="item.id">
                            <div class="log" :id="'scroll-' + item.id">
                                <pre :style="{'color': item.status === 'success' ? '#4e9a06': (item.status ==='error'? 'red' : '#9A7D0A'), 'font-size': '16px'}">{{item.description}}</pre>
                                <pre :id="'pre-' + item.id">{{item.log}}</pre>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="form-group point" v-show="showView === true">
            <button class="btn btn-primary btn-sm" style="width: 45%;margin-right: 3%;" @click="viewEndpoint()">View the app (Public URL)<i class="bi bi-box-arrow-up-right" style="margin-left: 2%;"></i></button>
            <button class="btn btn-secondary btn-sm"  style="width: 45%" @click="viewOnPortal()">Manage your app on Azure Spring Apps  <i class="bi bi-box-arrow-up-right" style="margin-left: 2%;"></i></button>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>
<script type="module">
    import {toast} from 'https://cdn.jsdelivr.net/npm/vue3-toastify@0.1.4/+esm';
    import Convert from 'https://cdn.jsdelivr.net/npm/ansi-to-html@0.7.2/+esm'
    const app = Vue.createApp({
        data() {
            return {
                gitUrl: new URLSearchParams(location.search).get('url'),
                branch: new URLSearchParams(location.search).get('branchName'),
                module: new URLSearchParams(location.search).get('module'),
                subscriptionId: new URLSearchParams(location.search).get('subscriptionId'),
                resourceGroupName: new URLSearchParams(location.search).get('resourceGroupName'),
                serviceName: new URLSearchParams(location.search).get('serviceName'),
                appName: new URLSearchParams(location.search).get('appName'),
                javaVersion: new URLSearchParams(location.search).get('javaVersion'),
                region: new URLSearchParams(location.search).get('region'),
                cpu: new URLSearchParams(location.search).get('cpu'),
                memory: new URLSearchParams(location.search).get('memory'),
                instanceCount: new URLSearchParams(location.search).get('instanceCount'),
                deploymentProgress: 'Your deployment is in progress...',
                deploymentResult: 'This operation may take a while.',
                showView: false,
                result: '',
                relativePath: '',
                uploadUrl: '',
                stages: [
                    {
                        key: 'provision',
                        id: 'provision-resource',
                        status: 'loading',
                        stageName: 'Provision resource',
                        description: '',
                        log: ''
                    },
                    {
                        key: 'upload',
                        id: 'upload-source-code',
                        status: 'wait',
                        stageName: 'Upload source code',
                        description: '',
                        log: ''
                    },
                    {
                        key: 'build',
                        id: 'build-source',
                        status: 'wait',
                        stageName: 'Build source',
                        description: '',
                        log: ''
                    },
                    {
                        key: 'deploy',
                        id: 'deployment',
                        status: 'wait',
                        stageName: 'Deploy',
                        description: '',
                        log: ''
                    },
                ],
                convert: new Convert({
                    fg: '#FFF', // default value
                    bg: '#000', // default value
                    newline: true, // default value is false
                    escapeXML: false, // default value
                    stream: false // default value
                }),
            }
        },
        methods: {
            handleListItemCollapse(iconId) {
                const icon = document.getElementById(iconId);
                if (icon.classList.contains('bi-chevron-right')) {
                    icon.classList.remove('bi-chevron-right');
                    icon.classList.add('bi-chevron-down');
                } else {
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-right');
                }
            },
            expandErrorCollapse(itemKey, itemId){
                const icon = document.getElementById(itemKey);
                if (!icon.classList.contains('bi-chevron-down')) {
                    icon.classList.remove('bi-chevron-right');
                    icon.classList.add('bi-chevron-down');
                    $('#' + itemId).collapse("toggle");
                }
            },
            checkAppExist(){
                this.stages[0].description = 'Check if app ' + this.appName + ' exists in ' + this.serviceName + '...';
                axios.get('/checkAppExist/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName)
                    .then(res => {
                        if(res.data === true){
                            this.handleProgress(0, 'App ' + this.appName + ' exists in service ' + this.serviceName + '.', 'success');
                            this.handleProgress(1, 'Uploading source code...', 'loading');
                            this.getUploadUrl();
                        } else {
                            this.stages[0].description = 'App ' + this.appName + ' not exist.';
                            const log = document.getElementById('pre-' + this.stages[0].id)
                            log.innerHTML = '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Creating app ' + this.appName + '...' + '</p>';
                            this.provisionResource(log);
                        }
                    }).catch(error => {
                    this.stages[0].log = error.response.data;
                    this.handleError(0, 'Create app ' + this.appName + ' in service ' + this.serviceName + ' failed.', 'Provision resource failed !');
                })
            },
            provisionResource(log) {
                axios.get('/provisionResource/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName)
                    .then(res => {
                        if (res.status === 200) {
                            log.innerHTML = '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Created app ' + this.appName + '.' + '</p>' + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Creating default deployment with name: default.' + '</p>';
                            this.createDeploymentForApp(log);
                        }
                    }).catch(error => {
                    log.innerHTML = '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Create app' + this.appName + ' failed.' + '</p>' + error.response.data;
                    this.handleError(0, 'Create app ' + this.appName + ' in service ' + this.serviceName + ' failed.', 'Provision resource failed !');
                    this.deleteApp();
                    })
            },
            createDeploymentForApp(log){
                axios.get('/createDeploymentForApp/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName + '/' + this.cpu + '/' + this.memory + '/' + this.instanceCount)
                    .then(res => {
                        if(res.status === 200 ){
                            this.handleProgress(0, 'Created app ' + this.appName + ' in service ' + this.serviceName + '.', 'success');
                            this.handleProgress(1, 'Uploading source code...', 'loading');
                            log.innerHTML = '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Created app ' + this.appName + '.' + '</p>' + '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Created default deployment with name: default.' + '</p>';
                            this.getUploadUrl();
                        }
                    }).catch(error => {
                    log.innerHTML = '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Created app ' + this.appName + '.' + '</p>' + '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Create default deployment with name: default failed.' + '</p>' + error.response.data;
                    this.handleError(0, 'Create app ' + this.appName + ' in service ' + this.serviceName + ' failed.', 'Provision resource failed !');
                    this.deleteApp();
                    })
            },
            getUploadUrl() {
                const log = document.getElementById('pre-' + this.stages[1].id)
                log.innerHTML = '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Getting upload url...' + '</p>';
                axios.get('/getUploadUrl/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName)
                    .then(res => {
                        if (res.status === 200) {
                            log.innerHTML = '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Get the upload url successfully.' + '</p>';
                            this.relativePath = res.data.relativePath;
                            this.uploadUrl = res.data.uploadUrl;
                            this.uploadFile(log);
                        }
                    }).catch(error => {
                    log.innerHTML = '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Get the upload url failed.' + '</p>' + error.response.data;
                    this.handleError(1, 'Upload source code failed.', 'Upload source code failed !');
                    this.deleteApp();
                })
            },
            uploadFile(log){
                const uploadLog = log.innerHTML;
                log.innerHTML = uploadLog + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Uploading file...' + '</p>';
                axios.post('/uploadFile',
                    {
                        'subscriptionId': this.subscriptionId,
                        'uploadUrl': this.uploadUrl,
                        'url': this.gitUrl,
                        'branchName': this.branch
                    })
                    .then(res => {
                        if (res.status === 200) {
                            log.innerHTML = uploadLog + '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Upload file successfully.' + '</p>';
                            this.handleProgress(1, 'Upload source code is complete.', 'success');
                            this.handleProgress(2, 'Building source in app ' + this.appName + '...', 'loading');
                            this.deploySourceCode();
                        }
                    }).catch(error => {
                    log.innerHTML = uploadLog + '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Upload file failed.' + '</p>' + error.response.data;
                    this.handleError(1, 'Upload source code failed.', 'Upload source code failed !');
                    this.deleteApp();
                })
            },
            deploySourceCode() {
                axios.get('/deploy' + '?module=' + this.module + '&subscriptionId=' + this.subscriptionId + '&resourceGroupName=' + this.resourceGroupName + '&serviceName=' + this.serviceName + '&appName=' + this.appName + '&javaVersion=' + this.javaVersion + '&relativePath=' + this.relativePath)
                    .then(res=> {
                        if(res.status){
                            this.result = 'success';
                        }else {
                            this.result = 'failed';
                        }
                    }).catch(error => {
                    console.log(error);
                }).finally(() => {
                    this.getBuildSourceResult();
                })
                this.getBuildLogs();
            },
            getBuildLogs() {
                axios.get('/getBuildLogs/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName)
                    .then(res => {
                        if (res.status === 200 && this.stages[2].status === 'loading' && this.result === '') {
                            this.getBuildLogs();
                        }
                        this.logScrollButtom(this.stages[2].id, res.data);
                    }).catch(error => {
                    this.stages[2].log = error.response.data;
                    this.handleError(2, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                    this.deleteApp();
                })
            },
            getBuildSourceResult(){
                if(this.stages[2].status === 'error'){
                    return;
                }
                axios.get('/getBuildSourceResult/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName)
                    .then(res => {
                        if (res.status === 200) {
                            this.handleProgress(2, 'Build source in app ' + this.appName + ' succeed.', 'success');
                            this.handleProgress(3, 'Deploying in app ' + this.appName + '...', 'loading');
                            this.getDeployResult();
                        } else {
                            this.logScrollButtom(this.stages[2].id, null);
                            this.handleError(2, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                            this.deleteApp();
                        }
                    }).catch(error => {
                    this.stages[2].log = error.response.data;
                    this.handleError(2, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                    this.deleteApp();
                })
            },
            getDeployResult() {
                axios.get('/getDeployResult/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName)
                    .then(res => {
                        if (res.status === 200) {
                            this.handleProgress(3, 'Your deployment of app ' + this.appName + ' succeeded.', 'success');
                            this.showView = true;
                            this.deploymentResult = '';
                            this.deploymentProgress = 'Your deployment is complete';
                            toast.success('Deployment succeeded !', {
                                position: toast.POSITION.TOP_CENTER,
                                autoClose: 5000,
                                hideProgressBar: true
                            });
                        } else {
                            this.handleError(3, 'Your deployment of app ' + this.appName + ' failed.', 'Deploy failed !');
                            this.deleteApp();
                        }
                        this.logScrollButtom(this.stages[3].id, res.data);
                    }).catch(error => {
                    this.stages[3].log = error.response.data;
                    this.handleError(3, 'Your deployment of app ' + this.appName + ' failed.', 'Deploy failed !');
                    this.deleteApp();
                })
            },
            deleteApp(){
                axios.get('/deleteApp/' + this.subscriptionId + '/' + this.resourceGroupName + '/' + this.serviceName + '/' + this.appName)
                    .then(() => {
                        console.log('Delete app succeed');
                    }).catch(error => {
                    console.log(error);
                })
            },
            handleProgress(num, description, status){
                this.stages[num].description = description;
                this.stages[num].status = status;
            },
            handleError(num, description, message){
                this.stages[num].status = 'error'
                this.stages[num].description = description;
                this.deploymentProgress = 'Your deployment is failed';
                this.deploymentResult = 'Please check the log and fix it.';
                this.expandErrorCollapse(this.stages[num].key, this.stages[num].id);
                toast.error(message, {
                    position: toast.POSITION.TOP_CENTER,
                    autoClose: 5000,
                    hideProgressBar: true
                });
            },
            logScrollButtom(logId, data) {
                if (data !== null){
                    const target = document.getElementById('pre-' + logId);
                    target.innerHTML = this.convert.toHtml(data)
                }
                const logScroll = document.getElementById('scroll-' + logId);
                logScroll.scrollTop = logScroll.scrollHeight;
            },
            viewEndpoint() {
                const endpoint = 'https://' + this.serviceName + "-" + this.appName + '.azuremicroservices.io/';
                open(endpoint);
            },
            viewOnPortal() {
                const portalUrl = 'https://ms.portal.azure.com/#@microsoft.onmicrosoft.com/resource/subscriptions/' + this.subscriptionId + '/resourceGroups/' + this.resourceGroupName + '/providers/Microsoft.AppPlatform/Spring/' + this.serviceName + '/application_dashboard';
                open(portalUrl);
            },
            stringify: JSON.stringify,
        },
        mounted() {
            this.checkAppExist();
        },
    })
    app.mount('#app')
</script>
</html>
