<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Azure Spring Apps Launcher Loading</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/vue3-toastify@0.1.4/dist/index.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.5/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.2.1/ansi_up.min.js"></script>
</head>
<style>
#app {
    background-image: linear-gradient(rgb(0,121, 212), rgb(60,42, 168));
    height: 100%;
    overflow-y: auto;
}
label {
    display: block;
    vertical-align: middle;
}
img {
    width: 10%;
    vertical-align: middle;
}
a,a:link,a:visited,a:hover,a:active{
    text-decoration: none;
    color:inherit;
}
pre{
    font-size: 14px;
    font-weight: 550;
    font-family: Courier New, monospace;
}
.btn{
    font-weight: 500;
}
.btn-primary{
    background-color: #1665DB;
}
.btn-primary:hover{
    background-color: #0C4CAB;
}
.btn-secondary{
    background: #FFFFFF;
    color: black;
    border: 1px solid #D1D1D1;
}
.btn-secondary:hover{
    background: #F5F5F5;
    color: black;
    border: 1px solid #C7C7C7;
}
.loading {
    width: 75%;
    margin: 4% auto 4%;
}
.icon-loading::before {
    color: white;
    font-size: 24px;
    background-color: #3366FF;
    border-radius: 50% 50%;
    animation: spin 1s infinite;
}
.icon-success {
    color: green;
    font-size: 24px;
}
.icon-error::before {
    color: red;
    font-size: 24px;
    vertical-align: 3px;
}
.inactive::before {
    background-color: #E0E0E0;
}
.rotating {
    animation: rotation 2s infinite linear;
}
@keyframes rotation {
    from {
        transform: rotate(0deg);
    }

    to {
        transform: rotate(360deg);
    }
}
.icon-container {
    width: 24px;
    height: 24px;
    float: right;
    padding-bottom: 5px;
}
.log {
    background-color: #f8f9fa;
    overflow: auto;
    padding: 15px;
    border: 1px solid #d6d8db;
    margin: 15px;
}
.log > pre:nth-child(2) {
    overflow: unset;
}

.title {
    padding: 0.5%;
    background-color: white;
}
.launcher {
    font-weight: 750;
    display: inline-block;
    margin-left: 20px;
    margin-top: 1.5%;
}
.back {
    font-weight: 650;
    float: right;
    margin-top: 1.5%;
}
.point{
    padding-left: 5%;
    padding-top: 2%;
    padding-bottom: 1%;
}
</style>
<body style="height: 100vh;">
<div id="app">
    <div class="title">
        <img src="img/nubesgen-logo.svg" alt="NubesGen logo">
        <label class="launcher">Azure Spring Apps Web Launcher</label>
        <label class="back"><a href="/">Back to NubesGen.com
            <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px"
                 viewBox="0 0 100 100" width="15" height="15" class="icon outbound">
                <path fill="currentColor"
                      d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path>
                <polygon fill="currentColor"
                         points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon>
            </svg>
        </a>
        </label>
    </div>
    <div class="loading">
        <div class="card border-light" style="border-radius: 8px;">
            <div class="card-body">
                <h6>{{deploymentProgress}}</h6>
                <span style="font-size: 14px;">{{deploymentResult}}</span>
            </div>
            <div class="card">
                <ul class="list-group list-group-flush" v-for="item in stages" :key="item.key">
                    <li class="list-group-item">
                        <div class="icon-container" v-show="item.status === 'success'">
                            <i class="bi bi-check-circle-fill icon-success d-flex align-items-center"></i>
                        </div>
                        <div class="icon-container rotating" v-show="item.status === 'loading'">
                            <i class="bi bi-arrow-repeat icon-loading d-flex align-items-center"></i>
                        </div>
                        <div class="icon-container" v-show="item.status === 'wait'">
                            <i class="bi bi-arrow-repeat icon-loading inactive d-flex align-items-center"></i>
                        </div>
                        <div class="icon-container" v-show="item.status === 'error'">
                            <i class="bi bi-exclamation-circle-fill icon-error d-flex align-items-center"></i>
                        </div>
                        <i @click="handleListItemCollapse(item.key)" class="bi bi-chevron-right"
                           :id="item.key" data-toggle="collapse" :data-target="'#'+item.id"></i>
                        <span class="ml-2">{{item.stageName}}</span>
                    </li>
                    <div class="collapse" :id="item.id">
                        <div class="log" :id="'scroll-' + item.id" :style="{'height': item.key === 'provision' || item.key === 'upload' || item.key === 'pipeline' ? (this.flag === 'create' && item.key === 'provision' ? '200px': '150px'): '400px'}">
                            <pre :id="'description'+ item.id" :style="{'color': item.status === 'success' ? '#4e9a06': (item.status === 'error' ? 'red' : '#9A7D0A')}">{{item.description}}</pre>
                            <pre :id="'pre-' + item.id">{{item.log}}</pre>
                        </div>
                    </div>
                </ul>
            </div>
            <div class="form-group point" v-show="showView === true">
                <button class="btn btn-primary btn-sm" style="width: 45%;margin-right: 3%;" @click="viewEndpoint()">{{viewEndpointDescription}}<i class="bi bi-box-arrow-up-right" style="margin-left: 2%;"></i></button>
                <button class="btn btn-secondary btn-sm"  style="width: 45%" @click="viewOnPortal()">Manage your app on Azure Spring Apps  <i class="bi bi-box-arrow-up-right" style="margin-left: 2%;"></i></button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>
<script type="module">
    import {toast} from 'https://cdn.jsdelivr.net/npm/vue3-toastify@0.1.4/+esm';
    import Convert from 'https://cdn.jsdelivr.net/npm/ansi-to-html@0.7.2/+esm'
    const app = Vue.createApp({
        data() {
            return {
                gitUrl: new URLSearchParams(location.search).get('url'),
                branch: new URLSearchParams(location.search).get('branchName'),
                module: new URLSearchParams(location.search).get('module'),
                subscriptionId: new URLSearchParams(location.search).get('subscriptionId'),
                resourceGroupName: new URLSearchParams(location.search).get('resourceGroupName'),
                serviceName: new URLSearchParams(location.search).get('serviceName'),
                appName: new URLSearchParams(location.search).get('appName'),
                javaVersion: new URLSearchParams(location.search).get('javaVersion'),
                cpu: new URLSearchParams(location.search).get('cpu'),
                memory: new URLSearchParams(location.search).get('memory'),
                instanceCount: new URLSearchParams(location.search).get('instanceCount'),
                tier: new URLSearchParams(location.search).get('tier'),
                region: new URLSearchParams(location.search).get('region'),
                variables: new URLSearchParams(location.search).get('variables'),
                flag: new URLSearchParams(location.search).get('flag'),
                code: new URLSearchParams(location.search).get('code'),
                githubAction: new URLSearchParams(location.search).get('githubAction'),
                deploymentProgress: 'Your deployment is in progress...',
                deploymentResult: 'This operation may take a while.',
                viewEndpointDescription: 'View the app (Public URL)',
                showView: false,
                api: '/springapps',
                pathName: '',
                result: '',
                relativePath: '',
                uploadUrl: '',
                buildSourceLogStandard: '',
                buildSourceLogEnterprise: '',
                clientId: '',
                accessToken: '',
                stages: [
                    {
                        order: 1,
                        key: 'provision',
                        id: 'provision-resource',
                        status: 'loading',
                        stageName: 'Provision resource',
                        description: '',
                        log: ''
                    },
                    {
                        order: 2,
                        key: 'upload',
                        id: 'upload-source-code',
                        status: 'wait',
                        stageName: 'Upload source code',
                        description: '',
                        log: ''
                    },
                    {
                        order: 4,
                        key: 'build',
                        id: 'build-source',
                        status: 'wait',
                        stageName: 'Build source',
                        description: '',
                        log: ''
                    },
                    {
                        order: 5,
                        key: 'deploy',
                        id: 'deployment',
                        status: 'wait',
                        stageName: 'Deploy',
                        description: '',
                        log: ''
                    },
                ],
                convert: new Convert({
                    fg: '#FFF', // default value
                    bg: '#000', // default value
                    newline: true, // default value is false
                    escapeXML: false, // default value
                    stream: false // default value
                }),
                enterpriseStages: ['prepare', 'analyze', 'detect', 'restore', 'build', 'export', 'completion'],
                enterpriseStagesIndex: 0,
                getBuildLogState: '',
            }
        },
        methods: {
            handleListItemCollapse(iconId) {
                const icon = document.getElementById(iconId);
                if (icon.classList.contains('bi-chevron-right')) {
                    icon.classList.remove('bi-chevron-right');
                    icon.classList.add('bi-chevron-down');
                } else {
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-right');
                }
            },
            checkAppExist() {
                this.expandCollapse(this.stages[0].key, this.stages[0].id);
                this.stages[0].description = 'Check whether app ' + this.appName + ' exists in ' + this.serviceName + '...';
                axios.get(this.api + '/checkAppExist',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName
                        }
                    }).then(res => {
                    if (!res.data) {
                        this.handleProgress(0, 'App ' + this.appName + ' already exists in service ' + this.serviceName + '.', 'success');
                        const log = document.getElementById('pre-' + this.stages[0].id)
                        log.innerHTML = '<p>' + '<i class="bi bi-caret-right" style="margin-right: 2%"></i>' + 'Skipped creating app ' + '<code style="color: blue">' + this.appName + '</code>' + '.' + '</p>' + '<p>' + '<i class="bi bi-caret-right" style="margin-right: 2%"></i>' + 'Skipped creating default deployment for app ' + '<code style="color: blue">' + this.appName + '</code>' + '.' + '</p>';
                        this.handleProgress(1, 'Uploading source code...', 'loading');
                        if(this.tier !== 'StandardGen2') {
                            this.handleProgress(1, 'Uploading source code...', 'loading');
                            this.getUploadUrl();
                        }else {
                            this.checkWorkFlowFile();
                        }
                    } else {
                        this.stages[0].description = 'App ' + this.appName + ' not exist, start creating';
                        this.provisionSpringApp();
                    }
                }).catch(error => {
                    this.stages[0].log = error.response.data;
                    this.handleError(0, 'Create app ' + this.appName + ' in service ' + this.serviceName + ' failed.', 'Provision resource failed !');
                })
            },
            provisionResourceGroup(){
                this.expandCollapse(this.stages[0].key, this.stages[0].id);
                this.stages[0].description = 'Provisioning resource' + '...';
                const log = document.getElementById('pre-' + this.stages[0].id)
                log.innerHTML = '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Creating resource group ' + '<code style="color: blue">' + this.resourceGroupName + '</code>' + '...' + '</p>';
                axios.get(this.api + '/provisionResourceGroup',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'region': this.region
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        log.innerHTML = '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Create resource group ' + '<code style="color: blue">' + this.resourceGroupName + '</code>' + ' successfully.' + '</p>';
                        this.provisionSpringService(log);
                    }
                }).catch(error => {
                    log.innerHTML = '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Create resource group ' + '<code style="color: blue">' + this.resourceGroupName + '</code>' + ' failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(0, 'Your resource group ' + this.resourceGroupName + ' is failed to create.', 'Provision resource failed !');
                })
            },
            provisionSpringService(log){
                const logs = log.innerHTML;
                log.innerHTML = logs + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Creating service ' + '<code style="color: blue">' + this.serviceName + '</code>' + '...' + '</p>';
                axios.get(this.api + '/' + this.tier.toLowerCase() + '/provisionSpringService',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'region': this.region,
                            'tier': this.tier
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        log.innerHTML = logs + '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Create service ' + '<code style="color: blue">' + this.serviceName + '</code>' + ' successfully.' + '</p>';
                        this.provisionSpringApp();
                    }
                }).catch(error => {
                    log.innerHTML =logs +  '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Create service ' + '<code style="color: blue">' + this.serviceName + '</code>' + ' failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(0, 'Your service ' + this.serviceName + ' is failed to create.', 'Provision resource failed !');
                })
            },
            provisionSpringApp() {
                const log = document.getElementById('pre-' + this.stages[0].id)
                const logs = log.innerHTML;
                log.innerHTML = logs + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Creating app ' + '<code style="color: blue">' + this.appName + '</code>' + '...' + '</p>';
                axios.get(this.api + '/provisionSpringApp', {
                    params: {
                        'subscriptionId': this.subscriptionId,
                        'resourceGroupName': this.resourceGroupName,
                        'serviceName': this.serviceName,
                        'appName': this.appName
                    }
                }).then(res => {
                    if (res.status === 200) {
                        log.innerHTML = logs +  '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Create app ' + '<code style="color: blue">' + this.appName + '</code>' + ' successfully.' + '</p>';
                        this.createDeploymentForApp(log);
                    }
                }).catch(error => {
                    log.innerHTML = logs + '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Create app ' + '<code style="color: blue">' + this.appName + '</code>' + ' failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(0, 'Create app ' + this.appName + ' in service ' + this.serviceName + ' failed.', 'Provision resource failed !');
                    this.deleteApp();
                })
            },
            createDeploymentForApp(log) {
                const provisionSourceLog = log.innerHTML;
                log.innerHTML = provisionSourceLog + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Creating default deployment for app ' + '<code style="color: blue">' + this.appName + '</code>' + '...' + '</p>';
                axios.post(this.api + '/createDeploymentForApp', {
                    'subscriptionId': this.subscriptionId,
                    'resourceGroupName': this.resourceGroupName,
                    'serviceName': this.serviceName,
                    'appName': this.appName,
                    'cpu': this.cpu,
                    'memory': this.memory,
                    'instanceCount': this.instanceCount,
                    'variables': this.variables,
                }).then(res => {
                    if (res.status === 200) {
                        this.handleProgress(0, this.flag === 'select' ? 'Created app ' + this.appName + ' in service ' + this.serviceName + '.': 'Provision resource is complete.', 'success');
                        log.innerHTML = provisionSourceLog + '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Create default deployment for app ' + '<code style="color: blue">' + this.appName + '</code>' + ' successfully.' + '</p>';
                        if(this.tier !== 'StandardGen2') {
                            this.handleProgress(1, 'Uploading source code...', 'loading');
                            this.getUploadUrl();
                        }else {
                            this.checkWorkFlowFile();
                        }
                    }
                }).catch(error => {
                    log.innerHTML = provisionSourceLog + '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Create default deployment for app ' + '<code style="color: blue">' + this.appName + '</code>' + ' failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(0, 'Create app ' + this.appName + ' in service ' + this.serviceName + ' failed.', 'Provision resource failed !');
                    this.deleteApp();
                })
            },
            getUploadUrl() {
                this.expandCollapse(this.stages[1].key, this.stages[1].id);
                const log = document.getElementById('pre-' + this.stages[1].id)
                log.innerHTML = '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Getting upload url...' + '</p>';
                axios.get(this.api + '/getUploadUrl',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        log.innerHTML = '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Get the upload url successfully.' + '</p>';
                        this.relativePath = res.data.relativePath;
                        this.uploadUrl = res.data.uploadUrl;
                        this.uploadFile(log);
                    }
                }).catch(error => {
                    log.innerHTML = '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Get the upload url failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(1, 'Upload source code failed.', 'Upload source code failed !');
                    this.deleteApp();
                })
            },
            uploadFile(log) {
                const uploadUrlLog = log.innerHTML;
                log.innerHTML = uploadUrlLog + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Uploading file...' + '</p>';
                axios.post(this.api + '/uploadFile',
                    {
                        'subscriptionId': this.subscriptionId,
                        'uploadUrl': this.uploadUrl,
                        'url': this.gitUrl,
                        'branchName': this.branch
                    })
                    .then(res => {
                        if (res.status === 200) {
                            log.innerHTML = uploadUrlLog + '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Upload file successfully.' + '</p>';
                            this.handleProgress(1, 'Upload source code is complete.', 'success');
                            if (this.tier !== 'Enterprise') {
                                if (this.githubAction === 'true') {
                                    this.checkWorkFlowFile();
                                }else {
                                    this.deploySourceCode();
                                }
                            } else {
                                if (this.githubAction === 'true') {
                                    this.checkWorkFlowFile();
                                }else {
                                    this.enqueueBuildForEnterpriseTier();
                                }
                            }
                        }
                    }).catch(error => {
                    log.innerHTML = uploadUrlLog + '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Upload file failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(1, 'Upload source code failed.', 'Upload source code failed !');
                    this.deleteApp();
                })
            },
            checkWorkFlowFile(){
                const index = this.tier === 'StandardGen2' ? 1 : 2;
                this.handleProgress(index, 'Check the workflow file...', 'loading');
                this.expandCollapse(this.stages[index].key, this.stages[index].id);
                axios.get(this.api + '/checkWorkFlowFile',
                    {
                        params: {
                            'url': this.gitUrl,
                            'branchName': this.branch,
                            'tier': this.tier
                        }
                    }).then(res => {
                    if (res.status === 200 ) {
                        this.branch = res.data.branchName;
                        this.pathName = res.data.pathName;
                        this.stages[index].description = 'Workflow file does not exist, start creating';
                        this.createCredentials(index);
                    }
                }).catch(error => {
                    console.log(error);
                    this.logScrollButtom(this.stages[index].id, 'The workflow file already exists in the repository.');
                    this.handleError(index, 'Set up CI/CD pipeline failed.', 'Set up CI/CD pipeline failed !');
                })
            },
            createCredentials(index){
                const log = document.getElementById('pre-' + this.stages[index].id)
                log.innerHTML = '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Creating service principal...' + '</p>';
                axios.get(this.api + '/createCredentials',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'appName': this.appName,
                            'url': this.gitUrl,
                            'branchName': this.branch,
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        log.innerHTML = '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Create service principal successfully.' + '</p>';
                        this.clientId = res.data;
                        this.pushSecretsToGitHub(log, index);
                    }
                }).catch(error => {
                    console.log(error);
                    log.innerHTML = '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Create service principal failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(index, 'Set up CI/CD pipeline failed.', 'Set up CI/CD pipeline failed !');
                })
            },
            pushSecretsToGitHub(log, index){
                const spLog = log.innerHTML;
                log.innerHTML = spLog + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Push secrets...' + '</p>';
                axios.get(this.api + '/pushSecretsToGitHub',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'serviceName': this.serviceName,
                            'resourceGroupName': this.resourceGroupName,
                            'appName': this.appName,
                            'url': this.gitUrl,
                            'clientId': this.clientId,
                            'code': this.code,
                            'tier': this.tier
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        log.innerHTML = spLog + '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Push secrets successfully.' + '</p>';
                        this.accessToken = res.data;
                        this.generateWorkflowFile(log, index);
                    }
                }).catch(error => {
                    console.log(error);
                    log.innerHTML =spLog + '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Push secrets failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(index, 'Set up CI/CD pipeline failed.', 'Set up CI/CD pipeline failed !');
                })
            },
            generateWorkflowFile(log, index){
                const wfLog = log.innerHTML;
                log.innerHTML = wfLog + '<p>' + '<i class="bi bi-slash-lg" style="margin-right: 2%"></i>' + 'Generate workflow file...' + '</p>';
                axios.get(this.api + '/generateWorkflowFile',
                    {
                        params: {
                            'url': this.gitUrl,
                            'branchName': this.branch,
                            'module': this.module,
                            'javaVersion': this.javaVersion,
                            'accessToken': this.accessToken,
                            'tier': this.tier,
                            'pathName': this.pathName
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        log.innerHTML = wfLog + '<p>' + '<i class="bi bi-check-lg" style="margin-right: 2%"></i>' + 'Generate workflow file successfully.' + '</p>';
                        this.handleProgress(index, 'Setting up the CI/CD pipeline is complete.', 'success');
                        if(this.tier === 'Standard'){
                            this.deploySourceCode();
                        }else if(this.tier === 'Enterprise') {
                            this.enqueueBuildForEnterpriseTier();
                        } else {
                            this.deploymentResult = '';
                            this.viewEndpointDescription = 'View Actions running status on GitHub';
                            this.showView = true;
                            this.deploymentProgress = 'Your deployment is complete';
                            toast.success('Deployment succeeded !', {
                                position: toast.POSITION.TOP_CENTER,
                                autoClose: 5000,
                                hideProgressBar: true
                            });
                        }
                    }
                }).catch(error => {
                    console.log(error);
                    log.innerHTML =wfLog + '<p>' + '<i class="bi bi-x-lg" style="margin-right: 2%"></i>' + 'Generate workflow file failed.' + '</p>' + '<code style="color: red">' + error.response.data + '</code>';
                    this.handleError(index, 'Set up CI/CD pipeline failed.', 'Set up CI/CD pipeline failed !');
                })
            },
            deploySourceCode() {
                let order = this.githubAction === 'true' ? 3 : 2;
                this.handleProgress(order, 'Building source in app ' + this.appName + '...', 'loading');
                this.expandCollapse(this.stages[order].key, this.stages[order].id);
                let deployResultData;
                axios.get(this.api + '/standard/deploy',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName,
                            'relativePath': this.relativePath,
                            'javaVersion': this.javaVersion,
                            'module': this.module
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        this.result = 'success';
                    }
                }).catch(error => {
                    console.log(error);
                    this.result = 'failed';
                    deployResultData = error.response.data;
                }).finally(() => {
                    this.getBuildSourceResult(order, deployResultData);
                })
                this.getBuildLogStandard(order);
            },
            getBuildLogStandard(order) {
                axios.get(this.api + '/standard/getBuildLogs',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName,
                            'githubAction': this.githubAction
                        }
                    }).then(res => {
                    if (res.status === 200 && this.stages[order].status === 'loading' && this.result === '') {
                        this.getBuildLogStandard(order);
                    }
                    this.buildSourceLogStandard = res.data;
                }).catch(error => {
                    console.log(error);
                    this.buildSourceLogStandard += error.response.data;
                }).finally(() => {
                    this.logScrollButtom(this.stages[order].id, this.buildSourceLogStandard);
                })
            },
            getBuildSourceResult(order, deployResultData) {
                if (this.result === 'failed' && this.buildSourceLogStandard.length === 0) {
                    this.handleError(order, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                    this.logScrollButtom(this.stages[order].id, deployResultData);
                    this.deleteApp();
                    return;
                }
                axios.get(this.api + '/standard/getBuildSourceResult',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        this.handleProgress(order, 'Build source in app ' + this.appName + ' succeed.', 'success');
                        this.handleProgress(order + 1, 'Deploying in app ' + this.appName + '...', 'loading');
                        this.getDeployResult(order + 1);
                    } else {
                        this.handleError(order, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                        this.logScrollButtom(this.stages[order].id, '');
                        this.deleteApp();
                    }
                }).catch(error => {
                    this.handleError(order, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                    this.logScrollButtom(this.stages[order].id, this.buildSourceLogStandard + '\n' + error.response.data === undefined ? '' : error.response.data);
                    this.deleteApp();
                })
            },
            getDeployResult(order) {
                this.expandCollapse(this.stages[order].key, this.stages[order].id);
                this.getDeployResultAndApplicationLogs(order);
            },
            enqueueBuildForEnterpriseTier() {
                let order = this.githubAction === 'true' ? 3 : 2;
                this.handleProgress(order, 'Building source in app ' + this.appName + '...', 'loading');
                this.expandCollapse(this.stages[order].key, this.stages[order].id);
                const javaVersion = this.javaVersion.substring(this.javaVersion.indexOf("_") + 1);
                axios.get(this.api + '/enterprise/enqueueBuild',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName,
                            'relativePath': this.relativePath,
                            'javaVersion': javaVersion,
                            'module': this.module,
                            'region': this.region
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        this.buildSourceCodeForEnterpriseTier(res.data, order);
                    }
                }).catch(error => {
                    this.handleError(order, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                    this.logScrollButtom(this.stages[2].id, error.response.data);
                    this.deleteApp();
                })
            },
            buildSourceCodeForEnterpriseTier(buildId, order) {
                axios.get(this.api + '/enterprise/buildSourceCode',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName,
                            'buildId': buildId
                        }
                    }).then(res => {
                    this.awaitGetBuildLogComplete(res.data, buildId, order);
                }).catch(error => {
                    this.handleError(order, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                    this.logScrollButtom(this.stages[order].id, this.buildSourceLogEnterprise + '\n' + error.response.data);
                    this.deleteApp();
                })
                this.getBuildLogEnterprise(order);
            },
            getBuildLogEnterprise(order) {
                if (this.enterpriseStagesIndex > this.enterpriseStages.length - 1) {
                    return;
                }
                axios.get(this.api + '/enterprise/getBuildLogs',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName,
                            'stage': this.enterpriseStages[this.enterpriseStagesIndex]
                        }
                    }).then(res => {
                    this.buildSourceLogEnterprise += res.data;
                    this.enterpriseStagesIndex++;
                    this.logScrollButtom(this.stages[order].id, this.buildSourceLogEnterprise);
                    this.getBuildLogEnterprise(order);
                }).catch(error => {
                    this.logScrollButtom(this.stages[order].id, this.buildSourceLogEnterprise + '\n' + error.response.data);
                })
            },
            awaitGetBuildLogComplete(result, buildId, order){
                if (this.enterpriseStagesIndex <= this.enterpriseStages.length - 1) {
                    setTimeout(() => this.awaitGetBuildLogComplete(result,buildId, order), 3000)
                    return;
                }
                if (result === 'Succeeded') {
                    this.handleProgress(order, 'Build source in app ' + this.appName + ' succeed.', 'success');
                    this.handleProgress(order + 1, 'Deploying in app ' + this.appName + '...', 'loading');
                    this.deploySourceCodeForEnterprise(buildId, order + 1);
                } else {
                    this.handleError(order, 'Build source in app ' + this.appName + ' failed.', 'Build source failed !');
                    this.logScrollButtom(this.stages[order].id, '');
                    this.deleteApp();
                }
            },
            deploySourceCodeForEnterprise(buildId, order) {
                this.expandCollapse(this.stages[order].key, this.stages[order].id);
                axios.get(this.api + '/enterprise/deploy',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName,
                            'buildId': buildId
                        }
                    }).then(() => {
                }).catch(error => {
                    console.log(error);
                }).finally(() => {
                    this.getDeployResultAndApplicationLogs(order);
                })
            },
            getDeployResultAndApplicationLogs(order) {
                axios.get(this.api + '/getDeployResultAndApplicationLogs',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName
                        }
                    }).then(res => {
                    if (res.status === 200) {
                        this.handleProgress(order, 'Your deployment of app ' + this.appName + ' succeeded.', 'success');
                        this.showView = true;
                        this.deploymentResult = '';
                        this.deploymentProgress = 'Your deployment is complete';
                        toast.success('Deployment succeeded !', {
                            position: toast.POSITION.TOP_CENTER,
                            autoClose: 5000,
                            hideProgressBar: true
                        });
                    } else {
                        this.handleError(order, 'Your deployment of app ' + this.appName + ' failed.', 'Deploy failed !');
                        this.deleteApp();
                    }
                    this.logScrollButtom(this.stages[order].id, res.data);
                    this.highlightLog(this.stages[order].id);
                }).catch(error => {
                    this.stages[order].log = error.response.data;
                    this.handleError(order, 'Your deployment of app ' + this.appName + ' failed.', 'Deploy failed !');
                    this.deleteApp();
                })
            },
            deleteApp() {
                axios.get(this.api + '/deleteApp',
                    {
                        params: {
                            'subscriptionId': this.subscriptionId,
                            'resourceGroupName': this.resourceGroupName,
                            'serviceName': this.serviceName,
                            'appName': this.appName
                        }
                    })
                    .then(() => {
                    }).catch(error => {
                    console.log(error);
                })
            },
            expandCollapse(itemKey, itemId) {
                const icon = document.getElementById(itemKey);
                if (!icon.classList.contains('bi-chevron-down')) {
                    icon.classList.remove('bi-chevron-right');
                    icon.classList.add('bi-chevron-down');
                    $('#' + itemId).collapse("toggle");
                }
            },
            handleProgress(num, description, status) {
                this.stages[num].description = description;
                this.stages[num].status = status;
            },
            handleError(num, description, message) {
                this.stages[num].status = 'error'
                this.stages[num].description = description;
                this.deploymentProgress = 'Your deployment is failed';
                this.deploymentResult = 'Please check the log and fix it.';
                this.expandCollapse(this.stages[num].key, this.stages[num].id);
                toast.error(message, {
                    position: toast.POSITION.TOP_CENTER,
                    autoClose: 5000,
                    hideProgressBar: true
                });
            },
            logScrollButtom(logId, data) {
                if (data.length > 0) {
                    const target = document.getElementById('pre-' + logId);
                    target.innerHTML = this.convert.toHtml(data)
                }
                const logScroll = document.getElementById('scroll-' + logId);
                logScroll.scrollTop = logScroll.scrollHeight;
            },
            highlightLog(id) {
                let log = document.getElementById('pre-' + id);
                let text = log.innerHTML.replace(/(\d+)/img, "<span style='color:blue;'>$&</span>");
                if (text.indexOf('INFO') !== -1) {
                    text = text.replaceAll('INFO', "<span style='color: green'>" + 'INFO' + '</span>');
                }
                if (text.indexOf('ERROR') !== -1) {
                    text = text.replaceAll('ERROR', "<span style='color: #E74C3C'>" + 'ERROR' + '</span>');
                }
                if (text.indexOf('DEBUG') !== -1) {
                    text = text.replaceAll('DEBUG', "<span style='color: #F4D03F'>" + 'DEBUG' + '</span>');
                }
                if (text.indexOf('WARN') !== -1) {
                    text = text.replaceAll('WARN', "<span style='color: #B7950B'>" + 'WARN' + '</span>');
                }
                if (text.indexOf('TRACE') !== -1) {
                    text = text.replaceAll('TRACE', "<span style='color: #F4D03F'>" + 'TRACE' + '</span>');
                }
                log.innerHTML = text;
            },
            viewEndpoint() {
                let endpoint;
                if(this.tier === 'StandardGen2'){
                    endpoint = this.gitUrl + '/actions/workflows/deploy-jar-to-asa.yml';
                }else {
                    endpoint = 'https://' + this.serviceName + "-" + this.appName + '.azuremicroservices.io/';
                }
                open(endpoint);
            },
            viewOnPortal() {
                const portalUrl = 'https://ms.portal.azure.com/#@microsoft.onmicrosoft.com/resource/subscriptions/' + this.subscriptionId + '/resourceGroups/' + this.resourceGroupName + '/providers/Microsoft.AppPlatform/Spring/' + this.serviceName + '/application_dashboard';
                open(portalUrl);
            },
            stringify: JSON.stringify,
        },
        mounted() {
            if(this.githubAction === 'true'){
                const pipeline = {
                    order: 3,
                    key: 'pipeline',
                    id: 'ci-cd-pipeline',
                    status: 'wait',
                    stageName: 'Set up CI/CD pipeline',
                    description: '',
                    log: ''
                }
                this.stages.push(pipeline)
                this.stages.sort((x, y) => x.order - y.order);
            }
            if(this.tier === 'StandardGen2'){
                this.stages = this.stages.filter(item => item.key !== 'upload' && item.key !== 'deploy' && item.key !== 'build');
            }
            if(this.flag === 'select'){
                this.checkAppExist();
            } else {
                this.provisionResourceGroup();
            }
            this.$nextTick(function () {
                $('.collapse').on('shown.bs.collapse', function (evt) {
                    evt.currentTarget.parentElement.scrollIntoView();
                });
            });
        },
    })
    app.mount('#app')
</script>
</html>
